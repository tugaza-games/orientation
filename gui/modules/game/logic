#NAMESPACE=gamelogic
dependencies::depends "gpscalc/haversine"
dependencies::depends "redis/redis"
dependencies::depends "queue/client"

namespaced EXPIRE_IN=60
namespaced GAME_QUEUE=game

function register_player(id latitude longitude accuracy) {
    local playername=$(redis::get "$id"-name)
    redis::update_list_item "players" "$id" ${namespaced EXPIRE_IN}
    redis::setex $id-position "{\"latitude\": $latitude, \"longitude\": $longitude, \"accuracy\": $accuracy, \"id\": \"$id\", \"name\": \"$playername\"}" ${namespaced EXPIRE_IN}
}

function distance(id) {
    local position=`redis::get "$id"-position`
    local latitude=`echo $position | jq .latitude`
    local longitude=`echo $position | jq .longitude`
    gps_haversine::distance $latitude $longitude `this::target | jq .latitude` `this::target | jq .longitude` | cut -d\. -f1
}

function bearing(id) {
    local position=`redis::get $id-position | jq .`
    local latitude=`echo $position | jq .latitude`
    local longitude=`echo $position | jq .longitude`
    gps_haversine::bearing $latitude $longitude `this::target | jq .latitude` `this::target | jq .longitude` | cut -d\. -f1
}

function hint(id) {
    local distance=`this::distance $id`
    this::target | jq -r ".hints[] | select (.min_distance <= $distance) | select (.max_distance >= $distance) | .hint" | base64 -d | jq -R -s '.'
}

function target() {
    local target_id=`queue_client::peek ${namespaced GAME_QUEUE}`
    if [[ -z $target_id ]]; then
        echo '{"longitude":0, "latitude":0, "hints":[{"min_distance":0, "max_distance":650437100, "hint":"R0FNRSBPVkVSLi4uIDxpbWcgaWQ9ImRpbWdfNjYiIHNyYz0iZGF0YTppbWFnZS9qcGVnO2Jhc2U2NCwvOWovNEFBUVNrWkpSZ0FCQVFBQUFRQUJBQUQvMndDRUFBa0dCd2dIQmdrSUJ3Z0tDZ2tMRFJZUERRd01EUnNVRlJBV0lCMGlJaUFkSHg4a0tEUXNKQ1l4Sng4ZkxUMHRNVFUzT2pvNkl5cy9SRDg0UXpRNU9qY0JDZ29LRFF3TkdnOFBHamNsSHlVM056YzNOemMzTnpjM056YzNOemMzTnpjM056YzNOemMzTnpjM056YzNOemMzTnpjM056YzNOemMzTnpjM056YzNOLy9BQUJFSUFJZ0JCQU1CSWdBQ0VRRURFUUgveEFBY0FBQUNBd0VCQVFFQUFBQUFBQUFBQUFBRUJRQURCZ0lCQndqL3hBQTlFQUFDQVFNREFnUUNDQVFGQkFNQkFBQUJBZ01BQkJFU0lURUZRUk1pVVdFR2NSUWpNb0dSb2JIUkIwTEI0U1JTWW9Md00wTnk4WkxDMGhYL3hBQVpBUUFEQVFFQkFBQUFBQUFBQUFBQUFBQUJBZ01BQkFYL3hBQWpFUUVCQUFJQ0FnTUFBZ01BQUFBQUFBQUFBUUlSSVRFREVnUVRRVEpSSWlOaC85b0FEQU1CQUFJUkF4RUFQd0RmK0UrQzdEQTlNOFVSRGNCVkNOSG4zQndhUDBPUVZKQjlzZjJvRzhnRVVveHZrWnhtdlJtVXo0cUE1VGw5YWthRlhiSm9DZHZGbFpnT1RWUWIwSi9HcnJhRjVuR25ZZXRHWXpIa0JGdmFvdm13RDcxYkprUm5HeFh1YXVNSUFHb3F6THh0UTkyVEhFUXpydnd0Um1YdFJXS3JjZVhqMHFxVzRFQ2p4QmtrOERlZ2ZwVXdBd1Z6N0NxVGxpV1k3MC8xMzlFYzkvbENzY1lVbnVUUWpBaHR3Y21pYlMyOFJkYmNFN0E1cXUrSitrTmtiZ0FVT0p4RFJ3Z3lDZUNCbXU0N29SUTZHUW51Q0R6WE5ySm9Mc3dCQVhjY1pxbGdaWlBxaGpKMldoVHJudklpQXhTVE9NRlFCZy9uUzlHUkpsYlQ1UWRnZDhVY2JCdis0VC90S24rdFVYOWswS0IwU1RTQnVXeHRTYjVZajY1MVdPeWtpZ01DemlmVm56RUVmMnJQM0hTN1JwZE02YWlUbjVVejZ0Wk0vVVlKbFh6TjlWcVBiQkovcitWQVgxMS9pMzhCVmxUT3hMaFNmY0QwcndzNS91eXRlNzQ3UHJ4a1ZOOE0yRWhVeGpSbm1yRytGckJzNkRLcDlWYkZHV2Q0a3NESFM0Wk9RZHpSVnRmMmtoQ0M0akVoL2tZNFA0R3JZNHloWXhuVittU2RNdVVLdnJRblk4ZmxYMHI0WDBqb2xxWkdRTUk4bHRzZ2ZLc2o4VXFyTEdOczVPSzBWcGJ5UWRNdEJJdVBxbDUrVlcrUGpyeThPWDVQR09qTzZuaU1CTUxLcExiZ051ZmJGQVlJNUZjeDZUSXVyak5FM3Fxc2lCQ0NQREhmTzllaHQ1eXFHVHdwVmYwTlBJSkZrakRLdzgzSXh4K2RJNDR6STJrYzQySHJVQmtoZk84Ymo3cWVVdGFaR0laV0RMNWRoelY2NThWUVZUT0Qvd0E0clAyZDVraFp6bkxjbW5FY2taa0RCbDR3TU9QM28yTUt1R0N3eU9WR2VCcHBSSE1ZbUREdHpUcktxdUdPRjdnaWxYVUlsMGVKRm4zcGNXZVhWMkx1SXF2bE9SbGNjVXFudDVJMll2NWh6cUEycnFDWEVwQjNWcVlYRFJ4b0RJUzNvb1BhbjBTMHBpWHppaXNWenBWcHN4SVZIY1VSbzlxYkdGcWtjVktzQzFLWUQwTTJCOVUrNTlWL2V1SjQxbDNNTWdiMUJYOTZ1QVh5aldjODhpdWlGS2srSVRqNWZ0WFB2VllubGpNYmFTRzlzMHdzM1JiWUV1RndmVVV1bmxMeWs1NDJGVSttUnYyTmRHV1B0anFpYlhIVUlvOVhna014NzByTEIySjVOZC9SWkdRTUNyZTJkNmtETEZOOVlDUFhiaWhqTWNlaEdwYVFsY05rc1JuMHhRa2xxOFp5UnFYMTlxWlJPV1FhU1hIK2tERkJ6M1J5MEtxQnZ1YzduMnBKYnNSdGlFZUZUZ0ZsL2xOQlhnQnVaUEtWMzROU0dTYTJiVUF4Qjc4aXVKcE5jak9RQVdPY0NoSnJLMDhpdFl0VDZlTTk2WXcya2NiSXdadFE1T2YwcGZIck1paEQ1anhUeU1TaEVEc05YM2pOSm5iREJwSFZGZnpqNzZvdUhBamNpUlMyazRCSGVpNWZFMFBnOSt4TlVONGpFZzQ0N2srdEwrTk9LeGxyY201c2J1UzVWU1kySVlLUHRESEZaeVNDRE9vd0lXNXl3eWEyRjEwNTdhMnZyaG5UdzVsR2xCL0tSdFdRbWtWUHRIQXJ5TThjc2J5OTdITERPN3c2R2RJajB2SVF1QmpCR0t1Ly9tQVRzeXpNcW4rUWdGZndOQzlNaXNHR0V1UnFiellXWEcrYWI2c3FXVWh2Zk5QaDF5R1VCcFpRemRWc29aOGVBajZpVHdUd3EvZVNLMndYeXgvVmc0UHRXYzZUYkM0dkZrWm1NY1pETUIzSU9SV2g3SnRKOXIvTS93QzlkbmdsbTY4NzVWbTRWWDlxNHVKSlVpd3V4T0NLRVluWlQyRk81MmpVU2tpVGIveTlLU093WjJZREFQRmRMa1gyUXpjeGozNy9BQ291OWdqOEpwTmc2NDRPYUN0R0F1SXlUamYxeFJOOWRySUJGR0FWVS9iSGMwWlNneUFkOXM5cXVpTHg0WTVHS0p0b1VVaVRETjdpckx4V2tUS2hDMlFCZzcvZ2FhQU50dW9ST3VrbGxrT0FNZDY2dTBFNDhObVlOam50V2Yxc3B4dXBvKzE2aURHVnVGSi8xWW84QlFqb3lQcElJSXF5Sk5YTkVYanhUU0tZbjE0WG5HS0w2ZlpoMUR5SzVYUEFvMjZEUy9wOW5wVlp3Z0xIMS84QWRkM05xemJ4eGdiOXNVZEZHcVI2VWljS0RzUCtHdTVRQUFkTERCQjcxTDdMS0ZJTkJCSVlZSVBGU20xeGFSdklXR3ZmL1NmMnFVLzJsV2pYcjRYai9uYW96U2VId3ZmK2IrMUIzRXdpalo5RGRnTnlNMERMZVBJTklCQS84aWYxclRDMEhrNmdUWUdPM0JvcTZ0d0xVT0J1QmswTGI2Q2N6U0JSVE5IaG1pS0J0YTR4ak5VeXl2Qm9EczVseG9sT3czWFA2VlZNUmNTdThRd09RSzh1b0RBQWNnZzlzOFZkMDFWWU14YnR4UTRuTEtQRm10MjhOZ1FPY0VBMWZZMjRsYnhXa0FHZU1ab3lTM1dhTGRNRUFnRTgwUDBsbVVPbStRZDZYZkhBd1k4YVN4T2hmZ25TY1lBcFNTTzFPMWR0RGZNOC9La1JKNzgwdU5VanVLUVJ5aHNaeDJwcERkd1RrTEdwVndNblkwRERDSnJaeHEwc0d5dnpvYU9acldiVmdGaHNSNjBNcEtKdk5wMHZ6ei9xL2VocFdoVExQa0JWeVNkUXF0ZW8yN1JhU3pJYzc2a3ovV2xmVWJwYmlWZ2pCb2w0d01acGZ4bGQ5ZVFHeWVGZy9oa2VkbWJ0N0NzaktFUmlGY0ZNK1Z4M0ZQOEFxSy80T1k0eDVmNmlzdzhTeTRVblQ3clhuL0p1OCtIcS9EeHVPQnRad0lzUVl5Qng3MFJicXJYQ1JMc3BZWnBkYTJLeDQrdWMrMmFZd0tFV1NSVHBFVWJPeDlOamlrdzVYOG05V3RXakFIQ3VTQU51S2dKOE5TR1g3WGRmNzFtUGhQNGt0dXBoWWlWam5BM2pZL21QYjI3VnBXYUpZOHNxREc1eXkvdlhvWTVUcDVHV04yOWNrR1RWSW9HQnloOVBuU0tiUjRyQ001WDF4aitwcTY4bGpsdU14cHRqZ1ZYTENVUlM0SWIrbFB1RjBxNzRwaEJaTTFzRktoWGJKODM1WW9HTWZXTDg2ZnhqSUgvNUI3VnBRc0xMRStIT29KT09EODZOdTVFaVJRR0VqWjI5UitGVHFFUThXUFNnRG5QQXhYbjBCbGhaNVd3Y2VVQWo4L1NtMlN3Q2tiM2M3RnlxYmJrVjFjV29oQ0hXVHErWDlEWGl5ZlJMaHNnRk9EZzE2am01dXcwbmRnTWUxTkN1NFZwMTB5UWFmRFluWWcxWGV4YVlrYzRHR3dLdDZXUUZkUjlxdGxlRzBaWVE2c09mWHRVbTA2RDV4eFhXZk5nZ0hVSzlKMkEwZHNjMXpscmxNbFI5WkgvOGY3MUtyaVp2REd3L0VWNVRhQm5KWnBiaHNuSjlnS2hqa1ZkVEl3SHlvNkNOWTRsSSsxemozcnB3SkpFeGdTWjQ1eFhUc3BhcXZJMmxGSk5kR0daVGp3MjFmMHBtaStadE8wZ08rUDhBbTlVM3NxeHhuemZXSGJORFlsbzFNY0x1YUlzN2cyMXpwY0RCSURaN1YzMDVVS3lha0piR0FkT2Fwdm9tRWpTS3AwNXhzT0syekhJWWF2ckdKMWJnRGlnTFZnbDlJcEJVTndCWFZqS0pJRmJTTmFjbjJvYTZuSzNobGlJT24wcGVtTm1rVVJ5SHo0QVByNlVrOFRBNW9yNmRISkRMa2hIWmRnMmQ2VjZpQjNIenBiVk1SNHUzV0l4bzJrTWN0NzdWTGUxa3VGMTVDSi9tSXBaUGZXOXBGcnVKQU04TG5jK3RaN3JYeHdzU2VIQzJ5OEtEdFVzL0pNWFJoNHJseTAzVUJEYlpKdWtZamthZjcwSjA2OHQ3aWJSQjV3ZHRSNDNyNVhmOWZ1YjZjdE5JMmpPZENuQVB0V3IvQUllVHRONHJPUVhHdHorUy93RDJya3o4K1ZXbUdFNGFMclVWM05ld1BhcXBSNDJEUjZ3TmlSNjBvdWJLNHRnSG5qS3JxeG5JTlgvRXIrYTNCWElaVHNlR3dmejVORGRJc0Z2RWVORzBGZHdNYzVJeitRcEw0NWxkeFhENUZ4MWplbDlxenp5Q0cyUU5KM0xjTDdtbUh4Q0Y2WjhMM3VIeTdwaG5QTEVuRk03Q3ppc1l3a1NZN3NjN2srOWZQdjRnZkVIMDI2RmhheUEyOExaZGwzMXYrdy9XdW54K1A2NXVwZWI1RjhsMU9tVWVaMGtEeE1VZFRrRUhHS2UyUHhsZXhhRlo5V1B0YXQ4MW1wRzh0REx1Yzk2bGxkOUpZNTJQcHRyOGJRa2hwYmRNL3dDbHNVNWkrSittOVFDcjRyUlNEZkVuQisrdmpSMlBKelZpU1BHZFNNUVI3MFpubEJ0eHY0KzNoU1JyaklaZHZNaHlLZFJZMkJRWnh0c1BTdmgzU09zM3ZUN3lLNWptYzZUNWtMSEREdURYMmZwOTFIZDJjTnpGSVJITEdIVTU3VjBZWmI3VHlrL0JFamF1cEloQUFVRGdDbU1tV1JnakFnTHg2R2xQVDM4VHFFamh0VzNjNU5HejNDUjI3UElDQ2VDR1BQNDFWT3dxNmswWnVQSVNHd05Yb2FLNlpQYXdBRXZoKytwVFM1STJsRE9PUnRqbmV2TGVQWE1JMmJRVDY5cU1wYkdna3ZyU1JESGdrSGZXQi82b1RYcFlsR1B0MnF1S3lrS2s2OXh3cktRYWtVY2piYUdIYmNVWUJqYmRRYnhWVjBVai9OazVwcmtsUnMrTSs5Wi93SmtHb28yQWVRTnFZV3Q0NFFSeUVZN0VpdGNQNkxSU0VESXkreHFVSmNYVExNd1FnajJxVXZyU3FyZEpDbzQ4VURCejJyc3hoNUFFeXJBWlk5ODEwaXM2WlJ5QjNKQXFocmhQRUJadE9GeGtMbkorNnFiQmZ6NWZzNDdqdlN6cUgvVlhJSU9NYjkvZXI3aS9qMGpjTTQ0Q29SK05MWnAybWZVNUdlTnVLRnJRWGJYcTI4SlZVTE1lY25BcW1XNmxkU3VkS25rTFhjRm1ERzBrcE9Pd0FQN1ZSZEtrWVRTUnFJM0djMHV6UFlwWFhVQTVBYm4zcGhhVzZHSU8yZk1RTVk3VXBVNzArdEo0M3RsQWpreXZwcXJiUEFsN1lOR0dtakE4UEhHZnMwc2RTdGFDOG1VMmpBTElNK3VjVWdrYWx0VXhmUDhBK0lkeTYzMXZHckVCWWM0SHV4L2FzWkkycmNuSjk2MDM4UWpuclFIYndGeCtKL3ZXVVpxOC93QWwvd0FxNmN1bzhKMzNvK3g2cmRXRUUvME80ZUNSd0UxSnpwSnlSK0lXbHhPYW01TzJkKzRwZEUzcHYvRWsrZzJhelJ5SXdSaVE4cGtPN0U1ejc4KzJjVVphU0VXVXVtVzVnYksvV1FRR1ZodWUzcFZIUzdTVm9Zb25zMXQ0dEhsa2h1eXg1OUt1bGltaG5PRjY0VlViVFdzb0ErUkdjbXFZOUJ2YTJUcjh0cmFHTWRldG1rS25DOVFzWGljKzJkUS9Tdm5Na3ZpTXo0QTFIT2xlQm5zSzFQWGVxdDlCbGdQVTc2UXkrVHdMMnkwa2p2aHRJL1dzaVR2VGUxdllWNDVKcmxhN09BS3BMYzBDdlMzMW1LN2I3STl6aXFVM09UelZ6N0JmVEpvUmxxU2NET01WOVgrQzc1ZW85QWdnaEpXUzJIaHlEUDRINUgrbGZJQ1N2bXJmZndyV1JyMjdsRDRoU0lCeDZrbmI5RFZNTHlMZGVhMmtWOFYzZTNQamxGVStVRElCOWF1dWwxeEsyZHgycGV3SGF1bVV0TituMjQ4RUdOZ1dKM0hJL1NoZW9xVXZXR0ZCMit6VlVVY2lnT0Evc3kxMU5JOHdIaUVOcEdCZ0FVOEpvMHNwUmNSQnlOSUI1NDNvcldYZER3QTJDUFgzcGQwMGd3NFlaQzhybmlqSldQaEJpY0FFYVd6bk85TkU2WUtWZFR0OVVPUlFsM0NJL1BIL0FOTnVQblZxdnFZQW5TQWRzSG1xK29xN0ZYQ2tSZ0Q4YTJQRkxhQ0I1K2RTdVZxVlFxcU41Wjl0VHQ3VjIwY3BCd2plWDdxTmdoTU1laVBCUGNtdTFPVkpZSFFHUEc5SUpDd0xTWTNERThZcGxiMnNTZ05xOHc5U1Awb0dlVWZTMmtVWUFmWVUwamtFc1FLZ2tuY2dETkpUT25CU1BPUitHS1VYYkdXNlJBZHdBdWFaVEZGVjJHeFZTZHRqU3l4UXlUaDJCT25jbjBvYlpaZVFpRmx3ZnRjakdQdm9qcFV6NjJoSkdHNHlhbDFERjRSa0lDdm5iYkdhR3QyOE5sZnVENjBEUTN2U3dzRDluOGZla012SDdVOHZ0QnN6cHlScUdEOTFKWnVOcVdxNHZsL3g5S3I5WktqN1VhNlB1d0QrcE5aVTFvZmpUYjRndXY4QXkvb0t6bW9haUs0Yy93Q1RveWUxMWtBSDFya25GZXFmVG1nblgwajRUc0JGSzBvNlJaV3hhRGE0aHVBN3Y3RmNiWnJycktoZXB6dDlINndDQUI0MXBLQW5IR25QUDNVcTZFOHRwYUxkV3ZSVmlab2gvaWt1QWRReUR1dWM3K2xXWHMvaTNrdHpKQjhRd0ZtUG10bUpqSUcyd0J4MjlLcHZocENUNGp1NUpIamcrbWRSbFFaWXgzc1lVcWVCZzRHZTlKTTcwWDFhNU4xMUNWL0h1WjBVQkkydVJod0FOd1I3RW1ob0VFa3lJemhGZGdwWWpJR2U5RFlkMTQyd29kemdmT3RlZmcwelJNOXIxYUF4NXdGa2pZTVQ4aDJvS2I0TTZpcHlzMXMrT3hKR2Z5cGZhVlcvSHovcG5ZcTZuZkIrUXE2YTFsczUzZ3VFMFNSbkREOXZhZ3JvbnhCbi9MVGRSS3l5NnJwVzhWZ3ZiTk51amRSbDZaMVNDN2dKQlJobGV6TDNCcExDMmtFMFNreUVaMytWQ1ZvL1FMTXNzUWVOdFNzTWdpaERFeFZuQTJGZkplaGZFdDkweVpQRG1rZUVmYWlkaVZJL3BYMTc0ZDZ0WTladENiZTRpSlpmTkdUaGtQdUs2Y2MydkpsMGtOSkN4VS9ZYlBmOTZzdjdBbkVpQTVQMnNrRDhNQ3FPbU40TjE0Y2dHQ05KNzcwOFZ2SUNFSUk3Z2dmMXpWcFU3R1ZMeVFTbG95Vkk1RlhEcWJNTkxveFh1b2t3RDc4VTM2cmErTkd6Rkk5YWVZbk9jaWs4Vm1adFJCQ2dkNmFVbGd1eXZQRmxXT2FRb3VRVk9jL2RUeG8vSGpiTG5HT1FRUWF6U2RPbUxLeTRZaGdkT2VhSlYyamZTQ3luNTRwdGI2VHNkQk56N0dwWHNaOHU1M3FWUW9wQXVrRU0vUFk1QnJ3dGhkVEZmS1NRRHRRY04zQTBZT3lGUnVBTVV0bm1MdG5VZEpQR2Fuc1V1SlEwck1RbzFIZkZHZEtjR1JocVVFRFlIdlZWcmJhUVRLbW9sZUJ3S0h1NERha0VOa0hqRzJLU2pETzluSzJyYllMN2JHcXVtcVJFOGhPQms4anRTeVc2ZVZVRXJFbE9EbXBKZG53MWlqOG80Sjd0UU1JbG5ra2NxOHVWQjJGSG1OVDA5WkZZWkI0b2V4c1NGekpwSmZZYjhWWXduc2dWeXBWd1Jua0dzYUxudUMzVHRQSlZoUzJSc2l1aTdCU003SHRROGpVdFZ4Zk0vaitNeGRmbkIvbVJHL0ZSV1IxWWszclcvd0FRcGpKOFF6YkhBUkJuL2JXUGtPR3pYQm4ydm1JYjFxQnUxY0JzcVBXdlVPOWFKVnJlaVcyTGFHYzlLdUZHa2dYWXVTVTlNbFB5cTZkZ2p5RVA4UVd2blk2b2sxb2R6dUJnN2VsQTlBaWphRlpWc2JyVXI0YTRXWDZvWkk1WFB6cSs4dVBCOFZsdk92VzU4MitqTWZQYjIvcFRqR2FubWFXYVNSNUhrTEVrdTR3emI4a2RqWHRwTWtWMUZKTGt4bzRaZ09jQ2hkUkl6bk81Sko3MXlUdlFMTHE3ZlJ1bjNRdTlNemFuTWcxTGp5NEZNZ0NNWVIvdk5ZWG9QVklvSWhiM016UXFweXJqdjdWcUxYcW5UTGdoSUwwdTQvbE1tYWxPSHFZZVQzeGxDL0YvVERQQUwyTWZXSU1PdnFQN1ZocnRmS3JlbXhyNnBKNGN0bzRCMUswWnI1ckl1bG1SaDlra1ZYSG5oeWZKeG44aTVRU3VsUWM1eWZsVmlIZkMwWHBGY21GU1FmU20rdHliVmtzQnZ0OHFLNlplM0ZuY3JMYnl2SEl2REExVm83MTR3TWVKWXh1T2FPdERMeSswZkRmVjVlcGRPZ3ZaVkFrMUZXOXlPOWJLQ1V1cEpZNEkxQUt2NzVyNXY4RFNBL0RjUlVqZVYvdTRyYjJ0eENscEhMSXFzY1lBSXlUK05kT0YzQnlXOVF2OVlNS2dnOE1mV3ErbW1RbVRqd3lBRHZqRkNTT2JtZG1qVEdkOGVsZTI5MElDd2tEYVA1aFZJbFlZUUh6cHJiN0xZSGJJK2RFM01FTW1YUnpyNDV6U3kzbHQySTBBYlAzWE5NNXJ3UUk3S3JIdHNNYjA4LzRuZUM4ZVhJYlk1cVZ3OXdabmFSbDNKcVU1Q2tNRllycXlCM29tRklTUjRzcUVrOW5BcGNyZWxIeDI4REJkUVk1WEo1cVd6RFJOR0F3UjAwOTh1TS9kVkYzQ2syblM1Qnh0NWdRYW8ralc1VTUxREIyM05jUFoyL1ptSGxPZDZEQW15ckZXeGtlbEcydG1jSkpNMjNPQUtXYXNiVXl0eGJ5eCtUT3M4NWM1SDUwREhVSWJJTWVRdWVEWFYxQ3M2THBZcXdQREhOQ1JKQXBBTFNaM3o5YTM3MWNzRVF5UThxZTVrYkg2MWhnQ1pUR3pLZTFDUzBUZHlxOG5rTEZSc0N6WnpRVXJVdFd4Zk92aVMzbXZPcjNqVHZMNGNiWVJBY2R2VTdBZTVyUERweG51REZiYXA1ZjhzUTJIeUozTmFqNCtXWitxMjBTQnlqd2pTby9tZlVRZm1lSzc2RGRRV1UwSFRiVXhpVno5ZE1UdHF4azcrZzRyaXp4NWRPcFNxRDRGNjQ2QjNoU0pEM2R0OGZLdVovaHBMTlQ5SjZnRllla1czNGsxb2JxNnVubGYvRW1RRTdhbklHUGxTN3FBTWxwSWs1UUFqWUx1YzFMMnY0Nlo4ZkNUZEM5R2g4TTZvbzd0NDllbHBvNVI0UjNIMmw1L0N2T3FYRHhRei80M3JVWTFNQXJRL1ZjOEE2ZVB2b2ZvQVVnTUlKV3dUOVlzdUZYZitaYzcxNTF1WXBheUo5SjZncGR5UERkUHEyMzN3Y2JDclRwd1h0bjgxNFRYSk5jazFQWlhyT2ZXdUVtZUNSWkl5UXlua1Y3WEJvd1piT21qZytMcmxiZndqQ0diR001NXBZYnlTNXVtbFpBaXR5QjJOTE03MWJITHBHTk9EUmsxMGJMeTVaVFZhVk9qM3JXcVhBU1B3M2lhUUh4QUNRb3lkdlhHK0tBSngyb2l5NlYxMjVzVXVMVzNlYTNjWUdpUVp3RDNCTkR5V2ZVVmZROWpjcTNvWXorMVY5dUUvVjVxelV6a1VSQjBYckZ3Y1JkTnVqL3MwL3JpbmZTZmdqckY1SXB2SXZvY09mTXpNQzMzQUg5YU85dE1kRzM4UFhrRm5lcC8yUklqSjh5RG45QitOYkJaY0x1ZGh4dnhRa2ZUNGVsMlVWdGF3SkhBcDJZSExNZlU3YzFiYVNrUGdSTklmWW1yNFRVYTFvclVwNENBRFNlNXhRZlU0MFRMcG5jNE8xVWZTNWlBRFp6WTlDZWZ5cm8za2dUZTJsSDM4ZmxWRTdRbHJkdERNR1hCVW5lajU3dDUzdzJCOHFVVHZtZlY0WlRKemcwenRMZ3hoc1J1emVxbmI5S2JGUElmQmJvSXhyazgxU3F4ZXYzdDVQOEFuM1Y1VGJJejRhbXNiblFNQS9aSHBVcVZNeUdSdEc2azcrdGVQSTNueUdBMGV0U3BXWWwxWndCM3J1SndrcTZ1ekROU3BRTTBGdkxHVThRSDZ0UnUvdlFsMU1zc3BZTmtjQ3BVckdpbG1xbGpYdFNscW1KTDhRV0wzZHVKYllMOUpoMWVFVDdqQi81N1ZnWjRMbnB6ZU5QQ3lCV3hoamc1enVLbFN1ZnlSZkM3T1laRnVJbG1paVlodHhodVBhZ2V0WExXOW9kSVdOMk9BQ2NrK3RlVks1SjI3Y3NyNmJVZEVUNnVGMWhnWlFkNUZreElNbmdqdUtvNjZ6Q01nTjFBSzc1MHlrZUVlZU5xbFNyYjRlZlNKalhtYWxTbEk5VWdFRWdFQWdrSHZSTjljd1hCWHdvZkR4eWFsU3NNb1BGUlZKNEdhbFNtZ1BxUDhPNVMvUXpFL01jcC9PdFdUZ2JibXBVcm93bkI5cERNMm9xMjRvbU9Vb3AvbXh2VXFVNUtXejNNc3dBZHRoMkFycXljaTVYRlNwUmhhWStLMkJrbm11akkyWDh4NDk2bFNuU0FYcHk2SC9UUnZUWkNkWTI0RlNwVFk5aFRGV2JISS9QOTZsU3BURWYvMlE9PSI+Cg=="}], "key":-1}'
        return
    fi
    local target=$(cat $DIR/vars/gamedata.json | jq --arg target $target_id '.[] | select (.id == $target) | .')
    if [[ `echo "$target" | jq -r '.type'` != "uuid" ]]; then
        echo $target
        return
    fi

    local id=`echo "$target" | jq -r '.uuid'`
    local position=`redis::get $id-position | jq .`
    local latitude=`echo $position | jq .latitude`
    if [[ -z $latitude ]]; then
        latitude=0
    fi
    local longitude=`echo $position | jq .longitude`
    if [[ -z $longitude ]]; then
        longitude=0
    fi
    target=`echo "$target" | jq --arg latitude "$latitude" --arg longitude "$longitude" '. + {"longitude":($longitude|tonumber), "latitude":($latitude|tonumber)}'`
    echo $target
}

function solve(solution_key) {
    if [[ `echo "$solution_key" | sha512sum | cut -d\  -f1` == $(echo `this::target` | jq -r .key ) ]]
    then
        this::advance
    fi
}

function advance() {
    logger::log "warn" "solved"
    queue_client::get ${namespaced GAME_QUEUE}
}

function player_positions() {
    local points=""
    for item in `redis::peek_multiple players 0 999`
    do
        local positem=`redis::get "$item"-position | jq -c .`
        if [[ $? -eq 0 && $positem != "" ]]; then
            points="$positem,$points"
        fi
    done
    points=${points%?}
    echo "$points"
}